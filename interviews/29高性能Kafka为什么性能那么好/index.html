<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>29｜高性能：Kafka为什么性能那么好？ | 爱狂热博客</title>
    <meta property="og:title" content="29｜高性能：Kafka为什么性能那么好？ - 爱狂热博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2024-09-11T00:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2024-09-11T00:00:00&#43;08:00'>
        
    <meta name="Keywords" content="golang,go语言,PHP,爱狂热,php,python,博客,项目管理,软件架构,公众号,小程序">
    <meta name="description" content="29｜高性能：Kafka为什么性能那么好？">
        
    <meta name="author" content="爱狂热">
    <meta property="og:url" content="http://hmx224.github.io/interviews/29%E9%AB%98%E6%80%A7%E8%83%BDKafka%E4%B8%BA%E4%BB%80%E4%B9%88%E6%80%A7%E8%83%BD%E9%82%A3%E4%B9%88%E5%A5%BD/">
    <link rel="shortcut icon" href='/favicon.ico' type="image/x-icon">
    <link rel="icon" href='/favicon.png' type="image/png">
    <link rel="alternate icon" href='/favicon.png' type="image/svg+xml">
    

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="http://hmx224.github.io/">
                        爱狂热博客
                    </a>
                
                <p class="description">专注于PHP、Python、Go语言(golang)、项目管理、软件架构、服务运维</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="" href="http://hmx224.github.io/">Home</a>
                    
                    <a  href="http://hmx224.github.io/go/" title="Golang">Golang</a>
                    
                    <a  href="http://hmx224.github.io/categories/" title="分类">分类</a>
                    
                    <a  href="http://hmx224.github.io/php/" title="php知识">php知识</a>
                    
                    <a  href="http://hmx224.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="http://hmx224.github.io/interviews/" title="面试">面试</a>
                    
                    <a  href="http://hmx224.github.io/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 200px;
        margin-left: -210px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
        display: none;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">Table of Contents</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
<ul>
<li><a href="#29-高性能-kafka-为什么性能那么好">29｜高性能：Kafka 为什么性能那么好？</a>
<ul>
<li><a href="#kafka-分段与索引">Kafka 分段与索引</a></li>
<li><a href="#零拷贝">零拷贝</a></li>
<li><a href="#批量操作的优势">批量操作的优势</a></li>
<li><a href="#面试准备">面试准备</a></li>
<li><a href="#面试思路">面试思路</a>
<ul>
<li><a href="#零拷贝-1">零拷贝</a></li>
<li><a href="#page-cache">page cache</a></li>
<li><a href="#顺序写">顺序写</a></li>
<li><a href="#分区多影响写入性能">分区多影响写入性能</a></li>
<li><a href="#分区过多如何解决">分区过多如何解决？</a></li>
<li><a href="#分区">分区</a></li>
<li><a href="#分段与索引">分段与索引</a></li>
<li><a href="#批量处理">批量处理</a>
<ul>
<li><a href="#批量处理高性能原因">批量处理高性能原因</a></li>
<li><a href="#批量处理的兜底技术">批量处理的兜底技术</a></li>
</ul></li>
<li><a href="#压缩">压缩</a></li>
</ul></li>
<li><a href="#面试思路总结">面试思路总结</a></li>
<li><a href="#思考题">思考题</a></li>
</ul></li>
</ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if (leftPos < 220) {
                postToc.css({ "width": leftPos - 10, "margin-left": (0 - leftPos) })
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }

        if ($("#TableOfContents").children().length < 1) {
            $(".post-toc").remove();
        }
    })
</script>
    <article class="post">
        <header>
            <h1 class="post-title">29｜高性能：Kafka为什么性能那么好？</h1>
        </header>
        
  <time datetime="2024-09-11T00:00:00Z" class="post-meta meta-date dt-published">
    2024-09-11
  </time>


<div class="post-meta meta-category">
  <span>&nbsp;|</span>
  
    <a href='/categories/go%E9%9D%A2%E8%AF%95' target="_blank">go面试</a>
  
</div>


        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">&nbsp;|
                <span id="busuanzi_value_page_pv"></span> <span>reads</span>
            </span>
        </div>
        
        
        <div class="clear" style="display: none">
            <div class="toc-article">
                <div class="toc-title">Table of Contents</div>
            </div>
        </div>
        
        <div class="post-content">
            

<h1 id="29-高性能-kafka-为什么性能那么好">29｜高性能：Kafka 为什么性能那么好？</h1>

<p>你好，我是大明。今天我们来讨论一个问题，Kafka 的性能为什么那么好？</p>

<p>Kafka 的高性能话题也算是热点了，如果你面试的公司在并发量或者数据量上已经到了一定地步，那么面试的时候大概率逃不过这个问题。</p>

<p>大部分人面不好这个部分的原因只有一个：Kafka 为了实现高性能采用的手段太多了，以至于根本记不住。那么这一节课我就先聚焦在 Kafka 本身为了高性能做了哪些事情，下一节课我再从实践出发，告诉你怎么优化 Kafka 的性能。</p>

<p>让我们先从 Kafka 的一些基本知识开始说起。</p>

<h2 id="kafka-分段与索引">Kafka 分段与索引</h2>

<p>即便在同一个分区内部，Kafka 也进一步利用了分段日志和索引来加速消息查找。在 Kafka 内部，一个分区的日志是由很多个段（segment）组成的，每个段你可以理解成一个文件。同一个 topic 的文件就存放在以 topic 命名的目录下。</p>

<p><img src="/images/interviews/689362/5b02d02b705bfd1b6afd1000b462bbaf.png" alt="图片" /></p>

<p>为了快速找到对应的段文件，段日志文件使用了偏移量来命名。假如说一个文件的名字是 N.log，那么就表示这个段文件里第一条消息的偏移量是 N + 1。</p>

<p>这里你就能猜到，Kafka 完全可以根据文件名来进行二分查找，从而快速定位到段文件。</p>

<p>为了加快段文件内的查找，每一个段文件都有两个索引文件。</p>

<ul>
<li>一个是偏移量索引文件，存储着部分消息偏移量到存储位置的映射，类似于 <code>&lt;offset, position&gt;</code> 这种二元组。这个 offset 不是全局 offset，是相对于这个文件第一条消息的偏移量。也就是说假如第一条消息的全局偏移量是 1000，那么偏移量为 1002 的消息的索引项是 <code>&lt;2, pos1&gt;</code>。</li>
<li>一个是时间索引文件，存储着时间戳到存储位置的映射，类似于 <code>&lt;timestamp, position&gt;</code> 二元组。</li>
</ul>

<p>所以整个日志文件目录看上去是这样的。</p>

<p><img src="/images/interviews/689362/880b85b2c0f64bdb72665b78615335e8.png" alt="图片" /></p>

<p>以这张图片为例，假如说要查找 topic 为 test_topic，分区为 1，偏移量为 20000 的消息，那么整个过程是这样的。</p>

<ol>
<li>在日志目录下找到名字为 test_topic_1 的子目录，里面就放着这个分区的消息日志文件。</li>
<li>在 test_topic_1 子目录下，根据文件名进行二分查找，可以确定 20000 这条消息应该放在010031.log 这个文件里面。</li>
<li>利用 010031.index 的内容进行二分查找，查找索引项。如果 20000 恰好有一个索引项 <code>&lt;20000, pos0&gt;</code>，那么就读取 pos0 这个位置的数据。</li>
<li>如果 20000 没有对应的索引项，就找到比 20000 小的最接近 20000 的索引项，假如有 <code>&lt;19990，pos1&gt;</code>，那么就从 pos1 往后遍历，找到 20000 对应的数据。</li>
</ol>

<p>对应的根据时间查找也差不多。这里要注意的是，索引文件放的只是部分消息对应的位置，因为 Kafka 希望索引文件能够装入内存。这种思想我之前提到过，我们在讨论 MySQL 索引的时候也是默认索引都在内存里面。</p>

<p>为了帮助你记忆，我整理成了三句话： <strong>topic 加分区定目录，偏移量定文件，索引定位置。</strong> 记住这三句话就可以了。</p>

<h2 id="零拷贝">零拷贝</h2>

<p>零拷贝（zero copy）是中间件广泛使用的一个技术，它能极大地提高中间件的性能。所谓的零拷贝，就是指没有 CPU 参与的拷贝。要理解零拷贝，要先从一般的读写操作开始讲起。假如说你现在要从磁盘读取内容，然后发送到网络上，那么基本流程如图所示。</p>

<p><img src="/images/interviews/689362/4ac629727b0538e96aeb2ed0c281ab15.png" alt="图片" /></p>

<p>DMA （Direct Memory Access）是一个独立于 CPU 的硬件，所以我们不太在意 DMA 拷贝。NIC（Network Interface Card）就是指网卡。</p>

<p>这里面总共有四个步骤。</p>

<ol>
<li>应用进入内核态，从磁盘里读取数据到内核缓存，也就是读缓存。这一步应用就是发了一个指令，然后是 DMA 来完成的。</li>
<li>应用把读缓存里的数据拷贝到应用缓存里，这个时候切换回用户态。</li>
<li>应用进入内核态，把应用缓存里的数据拷贝到内核缓存里，也就是写缓存。</li>
<li>应用把数据从写缓存拷贝到 NIC 缓存里，这一步应用也就是发了一个指令，DMA 负责执行。</li>
</ol>

<p>而这里面总共有四次内核态与用户态的切换。</p>

<p><img src="/images/interviews/689362/ee5003fd2cde138f4808e02bf887dd6f.png" alt="图片" /></p>

<p>为什么要那么复杂，能不能不经过应用缓存，直接让磁盘读到内核缓存，然后内核缓存直接写到 NIC 缓存？这样不是非常完美吗？</p>

<p><img src="/images/interviews/689362/ee3ae14795834184909a34279dc2d704.png" alt="图片" /></p>

<p>也可以，而这就是零拷贝，对应的内核态-用户态切换，也只剩下了两次。</p>

<p><img src="/images/interviews/689362/22af5f6b822a629a3847bb6da8e313c5.png" alt="图片" /></p>

<p>那么和最原始的操作比起来，零拷贝少了两次内核态与用户态的切换，还少了两次 CPU 拷贝。但是零拷贝本身还是要用到 DMA 拷贝。</p>

<h2 id="批量操作的优势">批量操作的优势</h2>

<p>批量操作在高性能中间件里面也很常见。那么批量操作的优势究竟在哪里呢？主要体现在两个方面：一个是更少的系统调用和内核态与用户态的切换，还有一个是高效利用网络带宽。</p>

<p>我给你举一个例子，客户端每次都只发一个请求到服务端上，如今要发 100 个请求。现在客户端用了零拷贝技术，那么客户端发送 100 个请求，需要 100 次系统调用，200次内核态与用户态的切换。而如果客户端一次性发送 100 个请求，那么它只需要 1 次系统调用，2 次内核态与用户态的切换。</p>

<p>在网络传输的时候，每一次发送都有一个固定开销，比如说协议头的部分，这个开销大小和具体的协议设计有关。假如说每个请求大小是 1KB，在网络传输的时候，分 100 次传输 1KB 和 1 次传输 100KB，后者也是明显快很多的。前者需要传输 100 次协议头，而后者只需要传输 1 次协议头。</p>

<p><img src="/images/interviews/689362/45b059b3a720a29a830c5e3edd43bfae.png" alt="图片" /></p>

<p>当然，这是指应用层协议，如果是底层协议，比如 TCP，这方面也能节省一些，但是效果不如应用层协议好。</p>

<h2 id="面试准备">面试准备</h2>

<p>准备Kafka高性能的面试，你还可以在公司内部了解一些信息。</p>

<ul>
<li>公司有没有因为分区或者 topic 太多导致 Kafka 性能衰退的案例？如果有，当时是怎么解决的？</li>
<li>公司内部的 Kafka 用的是机械硬盘还是固态硬盘？</li>
<li>公司内部的 Kafka 能撑住的并发量是多大？你的业务并发量是多大？</li>
<li>公司内部还有没有别的中间件也使用了类似的优化技术？</li>
<li>你在业务中有没有使用批量处理的技术来优化系统性能？如果有，具体是怎么做的？</li>
</ul>

<p>在面试中，比较好的策略是你根据自己对不同中间件的了解进行横向对比。比如说聊到 WAL 的时候，把它和 MySQL、Redis 进行对比。这样能够凸显你对系统设计原则有深刻的理解。</p>

<p>当你和面试官聊到了下面这些话题的时候，你都可以尝试引导到这节课的话题下。</p>

<ul>
<li>你们聊到了 WAL 和 AOF，可以提及 Kafka 利用了类似的技术。</li>
<li>你们聊到操作系统的基本原理，系统调用、文件 IO 等，你就可以提及零拷贝，批量处理技术在 Kafka 中的应用。</li>
<li>你们聊到了并发优化的内容，那么可以用分区作为例子解释缩小并发粒度的好处。</li>
<li>你们聊到其他中间件采用了后面我列举的技术，那么你就可以和 Kafka对比，深入阐述相关原理。</li>
<li>你们聊到了 Kafka 消息怎么存储，那么你就可以从性能的角度解释 Kafka 的分段和索引的优点。</li>
</ul>

<p>当然，面试官不一定直接问你为什么Kafka 性能那么高，他也可能有多种问法。</p>

<ul>
<li>你们公司的 Kafka 性能怎样？怎么做到的？</li>
<li>Kafka 为什么要用零拷贝？</li>
<li>分区太多为什么会导致 Kafka 性能衰退？</li>
<li>Kafka 为什么要用压缩技术？</li>
<li>Kafka 是怎么查找到特定偏移量的消息的？</li>
</ul>

<p>这一类问题，你都可以用后面的内容来回答。</p>

<h2 id="面试思路">面试思路</h2>

<p>Kafka 本身使用了很多手段来保证高性能，包括零拷贝、page cache（页缓存）、顺序读写、分区分段与索引、批量处理、压缩。其中零拷贝和顺序读写最重要，是一定要能回答出来的。</p>

<h3 id="零拷贝-1">零拷贝</h3>

<p>前面你已经了解了什么是零拷贝，那么你在回答的时候就可以介绍零拷贝是如何运作的，然后再总结零拷贝的优势。</p>

<blockquote>
<p>零拷贝是中间件设计的通用技术，是指完全没有 CPU 参与的读写操作。我以从磁盘读数据，然后写到网卡上为例介绍一下。首先，应用程序发起系统调用，这个系统调用会读取磁盘的数据，读到内核缓存里面。同时，磁盘到内核缓存是 DMA 拷贝。然后再从内核缓存拷贝到 NIC 缓存中，这个过程也是 DMA 拷贝。这样就完成了整个读写操作。和普通的读取磁盘再发送到网卡比起来，零拷贝少了两次 CPU 拷贝，和两次内核态与用户态的切换。</p>
</blockquote>

<p>正常来说，你在回答里面不需要介绍普通的读取磁盘再发送的流程，不过如果面试官问了，你就可以按照前置知识里面的内容来回答。这里还有可能引申到操作系统相关的基本知识，面试前你也不要忘了复习。</p>

<p>然后你再补充一句，引出 page cache 的内容。</p>

<blockquote>
<p>这里说的内核缓存，在 linux 系统上其实就是 page cache。</p>
</blockquote>

<h3 id="page-cache">page cache</h3>

<p>相信你对page cache并不陌生，前面我们接触过很多次了。Kafka 把数据写入到 page cache 而不是直接刷新到磁盘上，有效减少了真实的 IO 操作次数。</p>

<p>另外一方面，Kafka 是基于 JVM的，所以直接操作 page cache能够避开 JVM 的垃圾回收。同时也能充分利用操作系统对 page cache 的优化。</p>

<blockquote>
<p>Kafka 充分利用了 page cache。Kafka 写入的时候只是写入到了 page cache，这几乎等价于一个内存写入操作，然后依靠异步刷新把数据刷新到磁盘上。而 page cache 是可以存放很多数据的，也就是说 Kafka 本身调用了很多次写入操作之后，才会真的触发 IO 操作，提高了性能。而且，Kafka 是基于 JVM 的，那么利用 page cache 也能缓解垃圾回收的压力。大多数跟 IO 操作打交道的中间件都有类似的机制，比如说 MySQL、Redis。</p>
</blockquote>

<p>你在这里可以适当引导一下，把话题引导到消息丢失上。</p>

<blockquote>
<p>不过使用 page cache 的缺陷就是如果消息还没刷新到磁盘上，服务器就宕机了，那么整个消息就丢失了。</p>
</blockquote>

<h3 id="顺序写">顺序写</h3>

<p>在写操作里面，我们一般默认写是很慢的。但是实际上，写操作分成顺序写和随机写，我们认为写操作很慢，那都是随机写，而顺序写本身并不慢，所以你要先指出顺序写的性能。</p>

<blockquote>
<p>在计算机里面，普遍认为写很慢，但是实际上是随机写很慢，但是顺序写并不慢。即便是机械硬盘的顺序写也并不一定会比固态硬盘的顺序写慢。</p>
</blockquote>

<p>然后补充 Kafka 充分利用了顺序写。</p>

<blockquote>
<p>Kafka 在写入数据的时候就充分利用了顺序写的特性。它针对每一个分区，有一个日志文件 WAL（write-ahead log），这个日志文件是只追加的，也就是顺序写的，因此发消息的性能会很好。MySQL、Redis 和其他消息中间件也采用了类似的技术。</p>
</blockquote>

<p><img src="/images/interviews/689362/ff0cbe809be426d82f115a0c30996127.png" alt="图片" /></p>

<p>紧接着你再补充一点业界早期的讨论。</p>

<blockquote>
<p>所以早期的时候业界就有人做过实验，一台 Kafka 服务器，把磁盘从机械硬盘切换到固态硬盘，性能虽然有提升，但是并不明显。在固态硬盘很贵的情况下，并不划算。</p>
</blockquote>

<p>接下来你可以从两个角度刷亮点：分区多影响写入性能和如何解决分区多问题。</p>

<h3 id="分区多影响写入性能">分区多影响写入性能</h3>

<p>你应该注意到， Kafka 是每一个分区都有一个日志文件，万一你有很多分区呢？也就是说，如果分区特别多，就可能导致 Kafka 的写性能衰退。</p>

<blockquote>
<p>但是 Kafka 的顺序写要求的是分区内部顺序写，不同的分区之间就不是顺序写的。所以如果一个 topic 下的分区数量不合理，偏多的话，写入性能是比较差的。</p>

<p>举个例子，假如说要写入 100M 的数据，如果只有一个分区，那就是直接顺序写入 100M。但是如果有 100 个分区，每个分区写入 1M，它的性能是要差很多的。因为一个 topic 至少有一个分区，topic 多也会影响 Kafka 的性能。最好是在创建 topic 的时候就规划好分区，但是如果没规划好，还是得考虑解决。</p>
</blockquote>

<p><img src="/images/interviews/689362/59a137d035215d702c6db1d56c201236.png" alt="图片" /></p>

<p>这个回答里你提到了一个点，就是分区设置不合理，所以面试官就会追问你如何估计分区数量。这个知识你已经在前面 <a href="https://time.geekbang.org/column/article/685943">第 25 讲</a> 学过了，记得复习一下。</p>

<p>最后一句话，也是你引导面试官追问怎么解决分区或者 topic 过多的问题。</p>

<h3 id="分区过多如何解决">分区过多如何解决？</h3>

<p>我们从分区过多和 topic 过多的角度分别去讨论。</p>

<p>如果是分区过多的话很好办，你只需要 <strong>不使用其中的一些分区</strong> 就可以了。</p>

<blockquote>
<p>如果某个 topic 分区太多了用不上，就可以考虑不用其中的一些分区。假设说我们现在有 32 个分区，但是事实上业务本身用不上那么多分区，那么就可以考虑要求发送者只将消息发送到特定的 16 个分区上。当然，能够直接创建新 topic 是最好的。</p>
</blockquote>

<p><img src="/images/interviews/689362/c37146b35ef503b3dc83dbbd2ac3025c.png" alt="图片" /></p>

<p>topic 过多的问题，要稍微棘手一点，你可以考虑 <strong>合并</strong> topic。</p>

<blockquote>
<p>topic 过多的话，可以考虑合并一些 topic，但这也是看业务的。比如说最开始的设计是某个主业务下的子业务都有一个 topic，那么可以考虑这些子业务合并使用一个 topic，然后在里面用 type 等字段来标记是归属于哪个子业务的。</p>
</blockquote>

<p>有时候面试官可能会问，究竟多少个分区才算多，或者多少个分区才会导致性能下降呢？这里我给你一个阿里云中间件团队测试的结论。</p>

<blockquote>
<p>多少分区才算多，以及多少分区才会引起性能下降，这和 topic 本身有关，也和业务有关。</p>

<p>不过之前阿里云中间件团队测试过，在一个 topic 八个分区的情况下，超过 64 个 topic 之后，Kafka 性能就开始下降了。</p>
</blockquote>

<p>如果有兴趣，你也可以在你们公司的 Kafka 上执行一下测试。</p>

<h3 id="分区">分区</h3>

<p>分区本身就能带来性能的提升，分区的好处就是 Kafka 可以按分区来处理， <strong>减少并发竞争</strong>。</p>

<blockquote>
<p>Kafka 的分区机制也能提高性能。假如说现在 Kafka 没有分区机制，只有 topic，那么可以预计的是不管是读还是写，并发竞争都是 topic 维度的。而在引入了分区机制之后，并发竞争的维度就变成分区了。如果是操作不同的分区，那么完全不需要搞并发控制。</p>
</blockquote>

<p><img src="/images/interviews/689362/1cbd466eac09bba24ce608cd2cf26785.png" alt="图片" /></p>

<p>如果你在面试过程中和面试官讲到了并发优化的点，那么你可以用分区这个例子来解释可以通过缩小并发粒度来提高性能。</p>

<h3 id="分段与索引">分段与索引</h3>

<p>分段与索引的基本概念我们已经学过了，所以你只需要根据我总结的三句话简单介绍分段与索引就可以。同时讲清楚如何查找到特定消息，因为查找过程本身就是一个亮点。</p>

<blockquote>
<p>在 Kafka 中，每一个分区都对应多个段文件，放在同一个目录下。Kafka 根据 topic 和分区就可以确定消息存储在哪个目录内。每个段文件的文件名就是偏移量，假设为 N，那么这个文件第一条消息的偏移量就是 N+1。所以 Kafka 根据偏移量和文件名进行二分查找，就能确定消息在哪个文件里。</p>

<p>然后每一个段文件都有一个对应的偏移量索引文件和时间索引文件。Kafka 根据这个索引文件进行二分查找，就很容易在文件里面找到对应的消息。如果目标消息刚好有这个索引项，那么直接读取对应位置的数据。如果没有，就找到比目标消息偏移量小的，最接近目标消息的位置，顺序找过去。整个过程非常像跳表。</p>
</blockquote>

<h3 id="批量处理">批量处理</h3>

<p>批量处理是高并发和大数据的常见解决方案。Kafka 为了提高性能，引入端到端的批量发送机制。在发送端，Kafka 的客户端并不是一次只发送一条消息，而是发送一批消息（record batch）。简单来说，就是好几条消息合并在一起发送。</p>

<p><img src="/images/interviews/689362/a5acbbc1d81bdbf7365993666a2099e3.png" alt="图片" /></p>

<p>而在 broker 端，Kafka 在存储的时候也是按照批来处理的。你在回答的时候要先解释 Kafka <strong>批量处理</strong> 的基本机制。</p>

<blockquote>
<p>Kafka 还采用了批量处理来提高性能。Kafka 的客户端在发送的时候，并不是说每来一条消息就发送到 broker 上，而是说聚合够一批再发送。而在 broker 这一端，Kafka 也是同样按照批次来处理的，显然即便同样是顺序写，一次性写入数据都要比分多次快很多。除了 Kafka，很多高并发、大数据的中间件也采用类似的技术，比如说日志采集与上报就采用批量处理来提升性能。</p>
</blockquote>

<p>然后你可以从批量处理的高性能原因和兜底技术两个角度刷亮点。</p>

<h4 id="批量处理高性能原因">批量处理高性能原因</h4>

<p>首先你要深入分析批量处理高性能的原因。</p>

<blockquote>
<p>批量处理能够提升性能的原因是非常直观的，有两方面。一方面是减少系统调用和内核态与用户态切换的次数。比方说100 个请求发送出去，即便采用零拷贝技术，也要 100 次系统调用 200 次内核态与用户态切换。而如果是一次性发送的话，那么就只需要 1 次系统调用和 2 次内核态与用户态切换。</p>

<p>另外一方面，批量处理也有利于网络传输。在网络传输中，一个难以避免的问题就是网络协议自身的开销。比如说协议头开销。那么如果发送 100 次请求，就需要传输 100 次协议头。如果 100 个请求合并为一批，那就只需要一个协议头。</p>
</blockquote>

<p><img src="/images/interviews/689362/0390fc774852fe34893f50c86927bace.png" alt="图片" /></p>

<h4 id="批量处理的兜底技术">批量处理的兜底技术</h4>

<p>那么多大批次比较合适呢？关键词就是 <strong>要兜底</strong>。</p>

<blockquote>
<p>不过批次也要设计合理。正常来说批次总是越大越好，但是批次太大会导致一个后果，就是客户端难以凑够一个批次。比如说 100 条消息一批和 1000 条消息一批，后者肯定很难凑够一个批次。一般来说批量处理都是要兜底的，就是在固定时间内如果都没有凑够某个批次，那么就直接发送。比如说 Kafka 里面生产者就可以通过 <code>linger.ms</code> 参数来控制生产者最终等多长时间。时间到了，即便只有一条消息，生产者也会把消息发送到 broker 上。</p>
</blockquote>

<h3 id="压缩">压缩</h3>

<p>为了进一步降低数据传输和存储的压力，Kafka 还启用了压缩功能。Kafka 的压缩机制很特别。正常我们会认为如果 Kafka 支持压缩，那么应该是生产者压缩，发送到 broker 之后，broker 解压缩。然后 broker 压缩，发送到消费者之后，消费者解压缩。</p>

<p>Kafka 是彻底地端到端，就是生产者压缩之后发送到 broker，broker 直接存储。当 broker 推送到消费者的时候，消费者解压缩。</p>

<p><img src="/images/interviews/689362/2c94c7054eb25955d1fbee719e47101b.png" alt="图片" /></p>

<blockquote>
<p>Kafka 为了进一步降低网络传输和存储的压力，还对消息进行了压缩。这种压缩是端到端的压缩，也就是生产者压缩，broker 直接存储压缩后的数据，只有消费者才会解压缩。它带来的好处就是，网络传输的时候传输的数据会更少，存储的时候需要的磁盘空间也更少。当然，缺点就是压缩还是会消耗 CPU。如果生产者和消费者都是 CPU 密集型的应用，那么这种压缩机制反而加重了它们的负担。</p>
</blockquote>

<p>最后我们点出 CPU 密集型应用在使用 Kafka 的时候还面临着压缩数据竞争 CPU 资源的问题。不过在业界，CPU 密集型的应用非常少，会使用到 Kafka 的 CPU 密集型应用就更少了。</p>

<h2 id="面试思路总结">面试思路总结</h2>

<p>最后我来总结一下这节课的要点。通过 <strong>Kafka 的分段与索引技术</strong>，我们了解到一个消息是怎么被存储的，还有消息是怎么查找的。这里还引入了一个新概念—— <strong>零拷贝技术</strong>，你需要记住相比传统 IO 它独特的优势。</p>

<p>在回答Kafka 为什么性能这么好这个问题的时候，你要从 <strong>零拷贝、page cache、顺序写、分区、分段与索引、批量处理、压缩</strong> 这几个角度回答。而如果你记不住这么多内容，那么记住零拷贝、顺序写这两个也可以。</p>

<p>我也建议你从横向角度去分类，比如写下零拷贝再写下使用了零拷贝的相应的中间件。这样能够加深你的理解，你在面试的时候也可以用这个知识来刷亮点。</p>

<p><img src="/images/interviews/689362/5f9f06fdae07580aab5124a704943040.png" alt="" /></p>

<h2 id="思考题">思考题</h2>

<p>最后，请你来思考两个问题。</p>

<ul>
<li>Kafka 用到的这些优化技术，很多中间件也用到了，你能举几个例子吗？</li>
<li>我在分区里面讲到分区可以用来缩小并发粒度，减轻并发竞争，你还见过类似的技术吗？或者你有没有尝试在工作中使用类似的技术来优化自己的业务并发性能？</li>
</ul>

<p>欢迎你把你的答案分享在评论区，也欢迎你把这节课的内容分享给需要的朋友，我们下节课再见！</p>

        </div>

        


        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/interviews/01%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0AP%E5%92%8CCP%E4%BD%A0%E9%80%89%E5%93%AA%E4%B8%AA/">01｜服务注册与发现：AP和CP，你选哪个？</a></li>
        
        <li><a href="/interviews/02%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%9C%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6%E6%98%AF%E6%80%8E%E4%B9%88%E5%BD%B1%E5%93%8D%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84/">02｜负载均衡：调用结果、缓存机制是怎么影响负载均衡的？</a></li>
        
        <li><a href="/interviews/03%E7%86%94%E6%96%AD%E7%86%94%E6%96%AD-%E6%81%A2%E5%A4%8D-%E7%86%94%E6%96%AD-%E6%81%A2%E5%A4%8D%E6%8A%96%E6%9D%A5%E6%8A%96%E5%8E%BB%E6%80%8E%E4%B9%88%E5%8A%9E/">03｜熔断：熔断-恢复-熔断-恢复，抖来抖去怎么办？</a></li>
        
        <li><a href="/interviews/04%E9%99%8D%E7%BA%A7%E4%B8%BA%E4%BB%80%E4%B9%88%E6%AF%8F%E6%AC%A1%E5%A4%A7%E4%BF%83%E7%9A%84%E6%97%B6%E5%80%99%E6%80%BB%E6%98%AF%E8%A6%81%E6%8A%8A%E9%80%80%E6%AC%BE%E4%B9%8B%E7%B1%BB%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%81%9C%E6%8E%89/">04｜降级：为什么每次大促的时候总是要把退款之类的服务停掉？</a></li>
        
        <li><a href="/interviews/05%E9%99%90%E6%B5%81%E5%88%AB%E8%AF%B4%E7%AE%97%E6%B3%95%E4%BA%86%E5%B0%B1%E9%97%AE%E4%BD%A0%E9%98%88%E5%80%BC%E6%80%8E%E4%B9%88%E7%AE%97/">05｜限流：别说算法了，就问你“阈值”怎么算？</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/go%E9%9D%A2%E8%AF%95' target="_blank">go面试</a></li>
                
            </ul>
            
        </div>
    </article>
    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "yourdiscussshortname" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "https://github.com/hmx224/myHugo.git"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
    
    

</div>

                    <footer id="footer">
    <div>
        &copy; 2017 - 2024 <a href="http://hmx224.github.io/">爱狂热博客 By 爱狂热</a>

        | 版权所有 - <a href="https://beian.miit.gov.cn/" target="_blank">京ICP备16009734号-2 </a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.ifanatic.cn/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">爱狂热</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='http://hmx224.github.io/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="http://hmx224.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>

    <section class="widget">
        <h3 class="widget-title">Latest articles</h3>
<ul class="widget-list">
    
    <li>
        <a href="http://hmx224.github.io/post/laravel55%E5%8D%9A%E5%AE%A2%E9%A1%B9%E7%9B%AE%E8%AF%B4%E6%98%8Exblog/" title="Laravel55博客项目说明xblog" target="_blank">Laravel55博客项目说明xblog</a>
    </li>
    
    <li>
        <a href="http://hmx224.github.io/post/centos%E4%B8%AD%E5%AE%89%E8%A3%85GUI/" title="Centos中安装GUI" target="_blank">Centos中安装GUI</a>
    </li>
    
    <li>
        <a href="http://hmx224.github.io/post/Linux%E7%9A%84%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" title="Linux的启动流程" target="_blank">Linux的启动流程</a>
    </li>
    
    <li>
        <a href="http://hmx224.github.io/post/linux%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86%E7%A8%8B%E5%BA%8Fsystemd/" title="Linux服务管理程序systemd" target="_blank">Linux服务管理程序systemd</a>
    </li>
    
    <li>
        <a href="http://hmx224.github.io/post/supervisorInfo/" title="SupervisorInfo" target="_blank">SupervisorInfo</a>
    </li>
    
    <li>
        <a href="http://hmx224.github.io/post/resume/" title="Resume" target="_blank">Resume</a>
    </li>
    
    <li>
        <a href="http://hmx224.github.io/post/qrcode/" title="Qrcode" target="_blank">Qrcode</a>
    </li>
    
    <li>
        <a href="http://hmx224.github.io/post/ifanatic-blog-introduce/" title="记录早期爱狂热blog简介记录" target="_blank">记录早期爱狂热blog简介记录</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>categories</a></h3>
<ul class="widget-list">
    
    <li><a href="http://hmx224.github.io/categories/go/">go (1)</a></li>
    
    <li><a href="http://hmx224.github.io/categories/go%E9%9D%A2%E8%AF%95/">go面试 (51)</a></li>
    
    <li><a href="http://hmx224.github.io/categories/%E5%B7%A5%E5%85%B7/">工具 (1)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>tags</a></h3>
<div class="tagcloud">
    
    <a href="http://hmx224.github.io/tags/go/">go</a>
    
    <a href="http://hmx224.github.io/tags/go%E9%9D%A2%E8%AF%95/">go面试</a>
    
    <a href="http://hmx224.github.io/tags/php/">php</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">Links</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://www.ifanatic.cn/" title="爱狂热的博客">爱狂热的博客</a>
        </li>
        
        <li>
            <a target="_blank" href="http://www.humengxu.com" title="胡梦旭博客">胡梦旭博客</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">Meta</h3>
        <ul class="widget-list">
            <li><a href="http://hmx224.github.io/index.xml">RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>